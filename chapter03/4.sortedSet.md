# sorted Set
- 레디스에서 sorted set 은 스코어 값에 따라 정렬되는 고유한 문자열의 집합이다.
- 모든 아이템은 스코어-값 쌍을 가지며, 저장될 때부터 스코어 값으로 정렬되어 저장된다.
    - 같은 스코어를 가진 아이템은 데이터의 사전 순으로 정렬된다.
- 값은 중복 없이 유일하게 저장되므로 set 이랑 유사하나, 모든 값은 스코어라는 데이터에 연결되어 있어 hash 와도 비슷하다.
- 모든 아이템은 스코어 순으로 정렬되어 정렬된 리스트와 같으므로 list 처럼 인덱스 접근도 가능하다.
    - 인덱스를 이용해 아이템에 접근할 일이 많다면 list 보다 sorted set 이 더 효율적이다.
    - list 에서 인덱스 접근은 O(n) 이지만, sorted set 의 경우 O(log(n)) 으로 처리되기 때문이다.

## Command 종류
### `ZADD`
- sorted set 에 아이템을 저장하며, 스코어-값 쌍으로 입력해야 한다.
- 한 번에 여러 아이템 입력이 가능하다.
- 만약, 저장하고자 하는 데이터(값)이 이미 존재한다면 스코어만 업데이트되고, 재정렬된다.
- 지정한 키가 존재하지 않은 경우엔 sorted set 자료 구조가 새로 생성되고, 키가 존재하지만 sorted set 이 아니면 오류를 반환한다.
- 스코어는 배정밀도 부동소수점 숫자를 문자열로 표현한 값이어야 한다.
```shell
127.0.0.1:6379> ZADD score:2025 100 hyein
(integer) 1

127.0.0.1:6379> ZADD score:2025 150 jinju 150 juhyun 180 hyein
(integer) 2
```

**ZADD 의 옵션**
- **XX:** 아이템이 이미 존재할 때만 스코어를 업데이트한다.
- **NX:** 아이템이 존재하지 않을 때만 신규 삽입하고, 기존 아이템의 스코어를 업데이트하지 않는다.
- **LT:**
    - 업데이트하고자 하는 스코어가 기존 아이템의 스코어보다 작을 때만 업데이트한다.
    - 기존 아이템이 존재하지 않은 경우는 새로운 데이터를 삽입한다.
- **GT:**
    - 업데이트하고자 하는 스코어가 기존 아이템의 스코어보다 클 때만 업데이트한다.
    - 기존 아이템이 존재하지 않은 경우는 새로운 데이터를 삽입한다.

```shell
127.0.0.1:6379> ZADD score:2025 NX 100 hyein # NX, 이미 존재하는 hyein 저장
(integer) 0

127.0.0.1:6379> ZRANGE score:2025 0 -1 WITHSCORES
1) "jinju"
2) "150"
3) "juhyun"
4) "150"
5) "hyein"
6) "180"

127.0.0.1:6379> ZADD score:2025 NX 100 newval # NX, 새로운 값 저장
(integer) 1

127.0.0.1:6379> ZRANGE score:2025 0 -1 WITHSCORES # newval 저장 성공
1) "newval"
2) "100"
3) "jinju"
4) "150"
5) "juhyun"
6) "150"
7) "hyein"
8) "180"

127.0.0.1:6379> ZADD score:2025 XX 50 hyein # XX, 이미 존재하는 값의 스코어 변경
(integer) 0

127.0.0.1:6379> ZRANGE score:2025 0 -1 WITHSCORES
1) "hyein"
2) "50"
3) "newval"
4) "100"
5) "jinju"
6) "150"
7) "juhyun"
8) "150"

127.0.0.1:6379> ZADD score:2025 LT 40 hyein # LT, 더 작은 스코어로 업데이트
(integer) 0

127.0.0.1:6379> ZRANGE score:2025 0 -1 WITHSCORES
1) "hyein"
2) "40"
3) "newval"
4) "100"
5) "jinju"
6) "150"
7) "juhyun"
8) "150"
```

### `ZRANGE`
sorted set 에 저장된 데이터를 조회한다.
```shell
ZRANGE key start stop [BYSCORE|BYLEX] [REV] [LIMIT offset count] [WITHSCORES]
```
- start 와 stop 범위를 항상 입력해야 한다.
- **WITHSCORES:** 데이터와 함께 스코어 값을 차례대로 출력한다.
- **REV:** 데이터를 내림차순 정렬한다.
- **LIMIT:** offset 부터 count 수 만큼 출력한다.
    - BYSCORE 나 BYLEX 와 항상 같이 사용해야 한다.
- **BYSCORE:** 출력할 스코어 범위를 지정한다.
- **BYLEX:** 정해진 범위에서 같은 스코어를 가진 값들을 사전 순 정렬

**인덱스로 데이터 조회**
리스트와 같이 음수 인덱스가 올 수도 있다. 
```shell
127.0.0.1:6379> ZRANGE score:2025 0 -1 WITHSCORES # 전체 데이터 순서대로 출력
1) "hyein"
2) "40"
3) "newval"
4) "100" 
5) "jinju"
6) "150"
7) "juhyun"
8) "150"

127.0.0.1:6379> ZRANGE score:2025 1 3 WITHSCORES # 1~3 범위만 출력
1) "newval"
2) "100"
3) "jinju"
4) "150"
5) "juhyun"
6) "150"

127.0.0.1:6379> ZRANGE score:2025 1 3 WITHSCORES REV # 내림차순 정렬 후, 1~3 범위 출력
1) "jinju"
2) "150"
3) "newval"
4) "100"
5) "hyein"
6) "40"
```

**스코어로 데이터 조회**
- BYSCORE 옵션을 사용하면 스코어 범위로 조회할 수 있다.
- start, stop 인자에는 조회하고자 하는 최소, 최대 스코어를 전달하며, 최대 스코어가 포함된 결과가 나온다.
- 인수로 전달하는 스코어에 ( 문자를 추가하면 해당 스코어를 포함하지 않도록 할 수 있다.
```shell
127.0.0.1:6379> ZRANGE score:2025 40 100 BYSCORE WITHSCORES # 스코어 40~100 사이만 출력
1) "hyein"
2) "40"
3) "newval"
4) "100"

127.0.0.1:6379> ZRANGE score:2025 40 150 BYSCORE WITHSCORES LIMIT 0 2 # 40~150 스코어 범위 중 가장 높은 점수 2개 출력
1) "hyein"
2) "40"
3) "newval"
4) "100"

127.0.0.1:6379> ZRANGE score:2025 (40 100 BYSCORE WITHSCORES # 40 은 제외
1) "newval"
2) "100"

127.0.0.1:6379> ZRANGE score:2025 40 (150 BYSCORE WITHSCORES # 150 은 제외
1) "hyein"
2) "40"
3) "newval"
4) "100"
```

또한 최소, 최대 스코어에 infinity 를 의미하는 -inf, +inf 를 사용할 수 있다.
```shell
127.0.0.1:6379> ZRANGE score:2025 40 +inf BYSCORE WITHSCORES # 40 스코어 이상 모두 출력하기
1) "hyein"
2) "40"
3) "newval"
4) "100"
5) "jinju"
6) "150"
7) "juhyun"
8) "150"

127.0.0.1:6379> ZRANGE score:2025 -inf +inf BYSCORE WITHSCORES # 전체 데이터 스코어 출력하기
1) "hyein"
2) "40"
3) "newval"
4) "100"
5) "jinju"
6) "150"
7) "juhyun"
8) "150"
```

REV 옵션을 주어 역순으로 출력하고 싶을 땐 최소, 최대 스코어 전달 순서를 변경해야 한다.
```shell
127.0.0.1:6379> ZRANGE score:2025 150 -inf BYSCORE REV WITHSCORES # 150 스코어부터 역순 정렬 
1) "juhyun"
2) "150"
3) "jinju"
4) "150"
5) "newval"
6) "100"
7) "hyein"
8) "40"
```

**사전 순으로 데이터 조회**
- BYLEX 옵션을 주어 사전식 순서를 이용하여 특정 아이템을 조회할 수 있다.
- start, stop 은 사전 순으로 비교하기 위한 문자열을 전달해야 하고, 반드시 ( 나 [ 문자를 함께 입력해야 한다.
    - 입력한 문자열을 포함하면 [ 를 사용하고, 포함하지 않으면 ( 을 사용한다.
- 사전식 문자열의 가장 처음은 - 문자로, 가장 마지막은 + 로 대체할 수 있다.
- 문자열은 ASCII 바이트 값에 따라 사전식 정렬되므로 한글 문자열도 기준에 따라 정렬하거나 사전식 검색할 수 있다.
```shell
127.0.0.1:6379> ZRANGE score:2025 [hyein + BYLEX # hyein 포함
1) "hyein"
2) "newval"
3) "jinju"
4) "juhyun"

127.0.0.1:6379> ZRANGE score:2025 (hyein + BYLEX # hyein 미포함
1) "newval"
2) "jinju"
3) "juhyun"

127.0.0.1:6379> ZRANGE score:2025 - + BYLEX # 전체 데이터 조회
1) "hyein"
2) "jinju"
3) "juhyun"
4) "newval"
```