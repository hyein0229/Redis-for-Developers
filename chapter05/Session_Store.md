# 세션 스토어로서의 레디스
## 세션이란
- 세션은 서비스를 사용하는 클라이언트의 상태 정보를 의미
- 애플리케이션은 현재 로그인된 유저 상태를 저장하고, 유저가 서비스를 떠나면 세션을 삭제한다.
- 유저 정보를 유지하기 위해, 또는 사용자가 서비스에서 보내는 행동 분석을 통해 비즈니스 개선에도 활용할 수 있다.

### 세션 스토어가 왜 필요할까
- 초창기 규모가 작거나 프로토타입용 서비스라면 굳이 세션 스토어가 필요하지 않다.
    - 웹 서버 자체에 세션 스토어를 두고 세션을 관리하면 된다.
- 하지만, 규모가 커지면서 웹 서버를 확장한다면?
    - 각 확장된 웹 서버별로 세션 스토어를 관리한다면 정합성 문제가 발생한다.
    - 유저1이 서버1에서 세션이 저장된다면 서버에 재접속할 때마다 장바구니 목록이 사라졌다 있었다 할 수 있다.
- 해결 방법1 - 세션 고정 방식
    - 유저를 무조건 하나의 서버에 고정으로 접속시키는 것이다.
    - 하지만, **세션 고정 방식(sticky session)** 은 트래픽이 증가하는 경우 유연하게 다른 서버에 분산시킬 수 없다.
- 해결 방법2 - all-to-all 방식
    - 모든 세션 정보를 모든 웹 서버에 복제해서 저장
    - 모든 데이터가 모든 곳에 중복 저장되므로 불필요하게 저장 공간을 많이 차지하고 복제를 위한 네트워크 트래픽이 발생한다.
- 해결 방법2 - 별도 데이터베이스를 세션 스토어로 사용
    - 즉 웹 서버에 세션 정보를 저장하지 않고 DB 에서 관리하여 서버들은 DB 에서 읽고 쓰는 것이다.
    - 하나의 저장소를 공유해서 사용하므로 웹 서버 간 정합성 문제는 없다.
    - 하지만, 세션 스토어는 로그인되어 있는 동안 계속 액세스하므로 빠른 속도가 중요하다.
    - 디스크 기반 DB 는 유저가 많아질수록 성능 저하를 일으킬 수 있다.
- 해결 방법3 - 레디스같은 인메모리 DB 를 세션 스토어로 사용
    - 여러 서버에서 동일한 레디스 스토어를 바라보도록 구성한다. 
    - 세션이 하나에서 관리되므로 정합성 문제를 해결하고, 인메모리이므로 빠른 속도로 응답한다.
    - 또한 다양한 자료구조로 유저 데이터를 저장하기도 쉽고 간단하다. hash 는 세션 데이터를 저장하기에 알맞다.

```shell
> HMSET usersession:1 Name hyein IP 10:20:104:30 Hits 1
OK

> HINCRBY usersession:1 Hits 1
1) "2"
``` 

## 캐시와 세션의 차이
- 캐시와 세션은 비슷해보이나 데이터를 읽고 쓰는 패턴에 약간 차이가 있다. 
- 즉, 레디스를 캐시로 사용할 때와 세션 스토어로 사용할 때가 다르다.
- 캐시로 사용할 때
    - 일반적으로 look aside 전략을 이용하면 캐시에 없는 데이터는 원본 DB 에서 찾을 수 있다.
    - 캐시에 저장된 데이터는 여러 애플리케이션 서버에서 함께 사용할수록 더욱 효율적이다.
- 세션 스토어로 사용하는 경우
    - 세션 스토어에 저장된 데이터는 여러 사용자 간 공유되진 않는다. 
    - 즉, 저장된 데이터는 특정 유저에 한해서만 유효하다.
    - **일반적으로 유저가 로그인을 하고, 활성화된 상태에선 세션 스토어에만 데이터를 저장하고 확인한다.**
    - **유저가 로그아웃을 할 때 세션은 종류되고 이때 데이터 종류에 따라 데이터를 DB 에 영구 저장하거나 삭제한다.**
    - 최근 봤던 상품 목록은 휘발해도 되나, 장바구니에 담은 목록은 DB 에 저장시켜 나중에도 확인할 수 있게 할 수 있다.
- 하지만, 레디스로 세션 스토어를 사용할 땐 데이터가 휘발될 수도 있음을 항상 고려해야 한다.




